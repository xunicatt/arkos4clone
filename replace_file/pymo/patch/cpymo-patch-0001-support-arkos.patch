From 13b96de12b47c2dfc37accbe83b0895e65886310 Mon Sep 17 00:00:00 2001
From: lcdyk0517 <2670878301@qq.com>
Date: Fri, 26 Dec 2025 08:23:02 +0000
Subject: [PATCH] cpymo: handheld-friendly input mapping and ArkOS branding

---
 cpymo-backends/sdl2/Makefile              | 13 +++---
 cpymo-backends/sdl2/cpymo_backend_input.c | 57 +++++++++++++++--------
 cpymo/cpymo_engine.c                      | 18 +++++++
 3 files changed, 63 insertions(+), 25 deletions(-)

diff --git a/cpymo-backends/sdl2/Makefile b/cpymo-backends/sdl2/Makefile
index a061ea2..422030b 100644
--- a/cpymo-backends/sdl2/Makefile
+++ b/cpymo-backends/sdl2/Makefile
@@ -1,5 +1,5 @@
 .PHONY: build clean
-
+LDLIBS :=
 BUILD_DIR := $(shell mkdir -p build)build
 BUILD_DIR_CPYMO := $(shell mkdir -p $(BUILD_DIR)/cpymo)$(BUILD_DIR)/cpymo
 
@@ -31,8 +31,9 @@ ifeq ($(OS), Windows_NT)
 LDFLAGS += -lmingw32
 endif
 
-LDFLAGS += -lSDL2main -lSDL2 -lm
-
+LDLIBS += -lSDL2 -lm
+LDLIBS += -lwayland-egl -lwayland-client
+CFLAGS += -D__LINUX__
 ifeq ($(DISABLE_AUDIO), 1)
 CFLAGS += -DDISABLE_AUDIO -DDISABLE_MOVIE
 endif
@@ -67,9 +68,9 @@ endif
 ifneq ($(DISABLE_AUDIO), 1)
 ifeq ($(USE_SDL2_MIXER), 1)
 CFLAGS += -DDISABLE_MOVIE -DDISABLE_FFMPEG_AUDIO -DENABLE_SDL2_MIXER_AUDIO_BACKEND
-LDFLAGS += -lSDL2_mixer
+LDLIBS += -lSDL2_mixer
 else
-LDFLAGS += -lswscale -lavformat -lavcodec -lavutil -lswresample
+LDLIBS += -lswscale -lavformat -lavcodec -lavutil -lswresample
 endif
 endif
 
@@ -107,5 +108,5 @@ $(BUILD_DIR)/%.o: %.c $(INC)
 
 $(TARGET): $(OBJS)
 	@echo "Linking..."
-	@$(CC) $^ $(LDFLAGS) -o $@
+	@$(CC) $^ $(LDFLAGS) $(LDLIBS) -o $@
 	@echo "=> $@"
diff --git a/cpymo-backends/sdl2/cpymo_backend_input.c b/cpymo-backends/sdl2/cpymo_backend_input.c
index 6575397..0e9d434 100644
--- a/cpymo-backends/sdl2/cpymo_backend_input.c
+++ b/cpymo-backends/sdl2/cpymo_backend_input.c
@@ -6,7 +6,9 @@
 extern SDL_Renderer *renderer;
 extern SDL_Window *window;
 extern cpymo_engine engine;
-
+static bool l2_prev = false;
+static bool r2_prev = false;
+static bool trigger_skip_toggle = false;
 float mouse_wheel;
 
 SDL_GameController **gamecontrollers = NULL;
@@ -120,35 +122,50 @@ cpymo_input cpymo_input_snapshot()
 	MAP_CONTROLLER(out.left, SDL_CONTROLLER_BUTTON_DPAD_LEFT);
 	MAP_CONTROLLER(out.right, SDL_CONTROLLER_BUTTON_DPAD_RIGHT);
 	MAP_CONTROLLER(out.cancel, SDL_CONTROLLER_BUTTON_START);
-	MAP_CONTROLLER(out.cancel, SDL_CONTROLLER_BUTTON_GUIDE);
-	MAP_CONTROLLER(out.cancel, SDL_CONTROLLER_BUTTON_BACK);
 
-	MAP_CONTROLLER(out.hide_window, SDL_CONTROLLER_BUTTON_LEFTSHOULDER);
-	MAP_CONTROLLER(out.hide_window, SDL_CONTROLLER_BUTTON_LEFTSTICK);
-	MAP_CONTROLLER(out.skip, SDL_CONTROLLER_BUTTON_RIGHTSHOULDER);
 	MAP_CONTROLLER(out.skip, SDL_CONTROLLER_BUTTON_RIGHTSTICK);
 	
 	
 
 #if defined __SWITCH__ || defined __PSP__ || defined __PSV__
-	MAP_CONTROLLER(out.ok, SDL_CONTROLLER_BUTTON_B);
+	MAP_CONTROLLER(out.ok, SDL_CONTROLLER_BUTTON_A);
 	MAP_CONTROLLER(out.ok, SDL_CONTROLLER_BUTTON_X);
-	MAP_CONTROLLER(out.cancel, SDL_CONTROLLER_BUTTON_A);
-	MAP_CONTROLLER(out.cancel, SDL_CONTROLLER_BUTTON_Y);
+	MAP_CONTROLLER(out.hide_window, SDL_CONTROLLER_BUTTON_B);
+	MAP_CONTROLLER(out.hide_window, SDL_CONTROLLER_BUTTON_Y);
 #else
 	MAP_CONTROLLER(out.ok, SDL_CONTROLLER_BUTTON_A);
-	MAP_CONTROLLER(out.ok, SDL_CONTROLLER_BUTTON_Y);
-	MAP_CONTROLLER(out.cancel, SDL_CONTROLLER_BUTTON_B);
-	MAP_CONTROLLER(out.cancel, SDL_CONTROLLER_BUTTON_X);
+	MAP_CONTROLLER(out.ok, SDL_CONTROLLER_BUTTON_X);
+	MAP_CONTROLLER(out.hide_window, SDL_CONTROLLER_BUTTON_B);
+	MAP_CONTROLLER(out.hide_window, SDL_CONTROLLER_BUTTON_Y);
 #endif
 
 
 	for (size_t i = 0; i < gamecontrollers_count; ++i) {
-		if (abs(SDL_GameControllerGetAxis(gamecontrollers[i], SDL_CONTROLLER_AXIS_TRIGGERLEFT)) > 16384)
-			out.hide_window = true;
-		
-		if (abs(SDL_GameControllerGetAxis(gamecontrollers[i], SDL_CONTROLLER_AXIS_TRIGGERRIGHT)) > 16384)
+		if (SDL_GameControllerGetButton(gamecontrollers[i], SDL_CONTROLLER_BUTTON_LEFTSHOULDER))
 			out.skip = true;
+		if (SDL_GameControllerGetButton(gamecontrollers[i], SDL_CONTROLLER_BUTTON_RIGHTSHOULDER))
+			out.skip = true;
+
+        bool l2_now =
+	        SDL_GameControllerGetAxis(
+		        gamecontrollers[i],
+		        SDL_CONTROLLER_AXIS_TRIGGERLEFT) > 16384;
+
+        bool r2_now =
+	        SDL_GameControllerGetAxis(
+		        gamecontrollers[i],
+		        SDL_CONTROLLER_AXIS_TRIGGERRIGHT) > 16384;
+
+        /* rising edge toggles skip */
+        if ((l2_now && !l2_prev) || (r2_now && !r2_prev))
+	        trigger_skip_toggle = !trigger_skip_toggle;
+
+        if (trigger_skip_toggle)
+	        out.skip = true;
+
+        l2_prev = l2_now;
+        r2_prev = r2_now;
+
 
 		Sint16 x = SDL_GameControllerGetAxis(gamecontrollers[i], SDL_CONTROLLER_AXIS_LEFTX);
 		Sint16 y = SDL_GameControllerGetAxis(gamecontrollers[i], SDL_CONTROLLER_AXIS_LEFTY);
@@ -166,9 +183,11 @@ cpymo_input cpymo_input_snapshot()
 		else if (y < -30000) out.up = true;
 	}
 
-	bool fast_exit = false;
-	MAP_CONTROLLER(fast_exit, SDL_CONTROLLER_BUTTON_START);
-	if (fast_exit)
+	bool start_pressed = false;
+	bool select_pressed = false;
+	MAP_CONTROLLER(start_pressed, SDL_CONTROLLER_BUTTON_START);
+	MAP_CONTROLLER(select_pressed, SDL_CONTROLLER_BUTTON_BACK);
+	if (start_pressed && select_pressed)
 		cpymo_engine_exit(&engine);
 
 	#undef MAP_CONTROLLER
diff --git a/cpymo/cpymo_engine.c b/cpymo/cpymo_engine.c
index e84d62c..257e25e 100644
--- a/cpymo/cpymo_engine.c
+++ b/cpymo/cpymo_engine.c
@@ -21,6 +21,24 @@ static void cpymo_logo() {
 	puts("\\____/_/    \\__, /_/  /_/\\____/");
 	puts("           /____/");
 	puts("");
+    {
+    char buf1[] = {
+        0x67,0x67,0x67,0x7A,0x1B,0x28,0x31,0x15,0x09,0x6E,0x19,0x36,0x35,0x34,
+        0x3F,0x7A,0x60,0x60,0x7A,0x19,0x2A,0x23,0x17,0x15,0x7A,0x12,0x3B,0x34,
+        0x3E,0x32,0x3F,0x36,0x3E,0x7A,0x1F,0x3E,0x33,0x2E,0x33,0x35,0x34,
+        0x7A,0x67,0x67,0x67,0x00
+    };
+    for (int i = 0; buf1[i]; ++i)
+        buf1[i] ^= 0x5A;
+    puts(buf1);
+
+    char buf2[] = {
+        0x18,0x2F,0x33,0x36,0x3E,0x7A,0x38,0x23,0x7A,0x36,0x39,0x3E,0x23,0x31,0x00
+    };
+    for (int i = 0; buf2[i]; ++i)
+        buf2[i] ^= 0x5A;
+    puts(buf2);
+    }
 }
 
 static error_t cpymo_engine_non_pymo_warning(cpymo_engine *e) 
-- 
2.20.1

